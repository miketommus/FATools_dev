# **'FATools' R Package Development Notes**

## Package Description

The **FATools** package simplifies the analysis of **fatty acid (FA)** data using **R**. It provides commonly used functions for processing, analyzing, and plotting FA data resulting from chromatographic analyses. These functions ensure reproducibility, traceability, and consistency in work-products generated by the **CTEL Biomarker Lab**.

## Package Development Notes

### Writing Functions
* Use imperitive mood for naming functions 
    * e.g. do() not did() or does(), mutate() not mutated() or mutates(), hide() not hid() or hides().
* Minimize dependencies and limit them to highly used, reputable, and well-maintained packages.
* Avoid writing functions that use locale or global options.
* Put the most important function arguments first.
* Required arguments shouldn't have defaults, optional arguments should have defaults. 
*  Put ... after required arguments & before optional arguments. example:

```r
mean2 <- function(x, ..., na.rm = FALSE, trim = 0) {
  mean(x, ..., na.rm = na.rm, trim = trim)
}
```

* It's important that functions are written in a way that is agnositc to data management and workflow. For example, they should accept simple data frames rather than requiring a lab-specific compount table. This allows users to change how they do thing, but still allow the pacakge to be useful. It requires them to do more data cleaning, but that's normal. Refine this idea.

## Current State of the Package

* There is currently an [example script](https://github.com/miketommus/example-fatty-acid-analysis/blob/master/using_FATools.R) showing how to use the package. Needs more testing and documentation.
* Overall, package [documentation](https://style.tidyverse.org/documentation.html) sucks and really needs to be reworked once the core functions are working. 
* Need to develop testing procedures for all package functions.
* ~~Need to remove convert_fa_name() dependencies from all packages that currently have it. Just require users to convert their FA names before running those functions.~~

# **Functions To Add**

## filter_compound_by_prop()

Function that accepts GCMS proportion data and will filter out compounds that are below a threshold defined by the user (e.g. filter all FA that are less than 1% of total FA).

# **Functions in Package**

## convert_fa_name()

Function that accepts FA names in a variety of formats and will interconvert them between several supported standardized ways of writing FA names.

* ~~Needs a new name. Make it singular. Maybe change it to convert_fa_name().~~ 
* ~~Need to reevaluate required vs default arguments.~~
* Need to add some error checking. Use regex to look for unusual chars or unusual formats. Return which FA are problematic so user can fix them. 

```r
# A vector containing fatty acid names written in various ways
x <- c("c16.1w7c", "18.0", "20_1_w9", "i 15:0")

# Returns c("16:1ω7c", "18:0", "20:1ω9", "i-15:0")
convert_fa_name(x)

# Returns c("16.1 (n-7) c", "18.0", "20.1 (n-9)", "i-15.0")
convert_fa_name(
    x,
    style = 3,
    sep = ".",
    prefix_sep = "-",
    notation = "n"
)
```
## find_fa_name()

Function to search through character vector for fatty acid names. Returns an integer vector of indexes.

```r
 # Character vector containing some fatty acid names
 x <- c("c16.1w7c", "not-a-fa", "sample_id", "18.0", "20_1_w9", "i 15:0")

 # Returns integer vector c(1L, 4L, 5L, 6L)
 find_fa_name(x)
```

## calc_gc_response_factor()

Function takes cross-tab file of peak area results from external standards and creates an array containing FA names & RF. 
* This function currently sorts all concentrations and peak areas before it's calc. Should prob add error checking to ensure that all external standards are in order.

```r
# Make example peak area results
peak_areas <- data.frame(
  c(59690, 197032, 394075, 1041447),
  c(124260, 410732, 851543, 2092255),
  c(249962, 869479, 1895680, 4448913)
)

colnames(
  peak_areas
) <- c("8.0", "10.0", "16.0")

# Make example external standards proportions list
ext_standard_proportions <- data.frame(
  fa = c("8.0", "10.0", "16.0"),
  prop = as.numeric(c(0.01, 0.02, 0.05))

# Calculate response factors
calc_gc_response_factor(
  peak_areas,
  ext_std_concs = c(15, 50, 100, 250),
  ext_std_contents = ext_standard_proportions
)
```

## convert_area_to_conc()
Function to post-process GCMS data and convert peak areas into FAME concentrations.

* Need to add better error messaging about which FA are missing from rf_map.
* Add warning if FA are not converted when user doesn't input an rf_map.

```r
# example compound peak area data
data <- data.frame(
  runif(5, min = 1000, max = 3000000),
  runif(5, min = 1000, max = 3000000),
  runif(5, min = 1000, max = 3000000),
  runif(5, min = 1000, max = 3000000),
  runif(5, min = 1000, max = 3000000),
  runif(5, min = 1000, max = 3000000)
)
names(data) <- c("8:0", "10:0", "12:0", "14:0", "i-15:0", "15:0")

# example response factor table
rf_table <- data.frame(
  fa = c("10:0", "8:0", "12:0", "14:0", "i-15:0", "15:0"),
  rf = c(15000, 15000, 16000, 12000, 0, 10000)
)

# example response factor map
rf_map <- data.frame(
  fa = c("8:0", "10:0", "12:0", "14:0", "i-15:0", "15:0"),
  ref_fa = c(NA, NA, NA, NA, "15:0", NA)
)

# Convert areas to concentration
convert_area_to_conc(data, rf_table, rf_map = rf_map)

```

## adjust_conc_for_tissue_mass()
Function to take FAME concentrations and adjust them for the amount of tissue extracted. Also needs to account for the fraction of lipid extract processed for derivatization. 

* Improve documentation to describe the adjustments for lipid extract and volume used for derivatization.

```r
# example data
 data <- data.frame(
   runif(5, min = 1, max = 10),
   runif(5, min = 1, max = 10),
   runif(5, min = 1, max = 10)
 )
 names(data) <- c("8:0", "10:0", "12:0")
 tiss_mass <- rep(10, 5)

 # Adjust concentration for tissue mass
 adjust_conc_for_tissue_mass(data, tiss_mass)

```

## convert_result_to_prop()
Function to convert concentrations into proportions. Basically all it needs to do is divide each FA concentration value by the sum of the row.

```r
 # example data
 data <- data.frame(
   runif(5, min = 1000, max = 300000),
   runif(5, min = 1000, max = 300000),
   runif(5, min = 1000, max = 300000),
   runif(5, min = 1000, max = 300000),
   runif(5, min = 1000, max = 300000)
 )
 names(data) <- c("8:0", "10:0", "12:0", "13:0", "14:0")

 # Convert example data to proportions
 convert_result_to_prop(data)
```

# **R Package Development Resources**

[R Packages e-book](https://r-pkgs.org/whole-game.html)

[Tidy Design Principles](https://design.tidyverse.org/)

[Tidyverse Style Guide](https://style.tidyverse.org/functions.html)

[CRAN Repository Policy](https://cran.r-project.org/)

[GitHub Documentation](https://docs.github.com/en/get-started)

[Git Book](https://git-scm.com/book/en/v2)

[Git Visual Cheatsheet](https://ndpsoftware.com/git-cheatsheet.html#loc=workspace;)

# **Collaboration Guidelines**

* [GitHub](https://github.com/miketommus/FATools) will be the main repository and "source of truth" for the project.
* All dev work should be done on branches and then a pull request used to merge with master branch. 
* Use of Git locally on your computer for version control is highly recommended. In order to keep the commit history clean, please use the [The Repeated Amend](https://happygitwithr.com/repeated-amend) technique and only push commits to the GitHub repo that represent a unified chunk of work. 
* Clean, easy-to-read & maintain code.